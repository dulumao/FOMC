<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOMC宏观数据情报工作台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --neutral-900: #0f172a;
            --neutral-800: #1f2937;
            --neutral-700: #334155;
            --blue-700: #1f2c3d;   /* 非农主色 */
            --blue-500: #2b63d9;
            --orange-700: #b45309; /* CPI 主色 */
            --orange-500: #f97316;
            --teal-600: #0f766e;   /* 数据浏览色调 */
            --light-bg: #f6f7fb;
            --card-bg: #ffffff;
            --card-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --card-border: 1px solid rgba(0, 0, 0, 0.125);
        }
        
        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .header {
            background: linear-gradient(135deg, var(--neutral-900), var(--neutral-700));
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .workspace-tabs .nav-link {
            border: 1px solid transparent;
            color: var(--teal-600);
            font-weight: 600;
        }
        .workspace-tabs .nav-link.active {
            background: var(--teal-600);
            color: #fff;
            border-color: var(--teal-600);
        }
        .workspace-tabs .nav-link:not(.active):hover {
            border-color: var(--teal-600);
            color: var(--teal-600);
        }
        
        .card {
            box-shadow: var(--card-shadow);
            border: var(--card-border);
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        
        .indicator-category {
            margin-bottom: 0.3rem;
        }
        
        .category-header {
            background: linear-gradient(135deg, var(--teal-600), #128c7e);
            color: white;
            padding: 0.4rem 0.6rem;
            border-radius: 0.375rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.15rem;
            font-size: 0.85rem;
        }
        
        .category-header:hover {
            background-color: #1a2530;
        }
        
        .indicator-list {
            padding: 0.15rem;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .indicator-item {
            padding: 0.3rem 0.4rem;
            margin-bottom: 0.15rem;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
        }
        
        .indicator-item:hover {
            background-color: #e0f2fe;
            border-color: var(--teal-600);
            transform: translateX(3px);
        }
        
        .indicator-item.active {
            background-color: #e0f2fe;
            border-color: var(--teal-600);
        }
        
        .fred-link {
            text-decoration: none;
            transition: color 0.2s ease;
        }
        
        .fred-link:hover {
            color: #0d6efd !important;
            text-decoration: underline;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 1rem;
        }
        
        .data-table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .footer {
            background-color: var(--dark-bg);
            color: white;
            padding: 1.5rem 0;
            margin-top: 2rem;
        }
        
        .filter-section {
            background: linear-gradient(to right, #edf2f7, #e2e8f0);
            padding: 1.25rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.05);
        }
        
        .filter-section .form-label {
            font-weight: 500;
            color: var(--neutral-900);
        }
        
        .btn-primary {
            background-color: var(--blue-500);
            border-color: var(--blue-500);
        }

        .btn-primary:hover {
            background-color: #234ca7;
            border-color: #234ca7;
        }

        .btn-nonfarm {
            background: linear-gradient(135deg, var(--blue-700), var(--blue-500));
            color: #fff;
            border-color: var(--blue-700);
        }
        .btn-nonfarm:hover { color:#fff; opacity: 0.95; }
        .btn-nonfarm-outline {
            color: var(--blue-700);
            border-color: var(--blue-500);
            background: #fff;
        }
        .btn-nonfarm-outline:hover {
            background: var(--blue-500);
            color: #fff;
        }
        .btn-cpi {
            background: linear-gradient(135deg, var(--orange-700), var(--orange-500));
            color: #fff;
            border-color: var(--orange-700);
        }
        .btn-cpi:hover { color:#fff; opacity: 0.95; }
        .btn-cpi-outline {
            color: var(--orange-700);
            border-color: var(--orange-500);
            background: #fff;
        }
        .btn-cpi-outline:hover {
            background: var(--orange-500);
            color: #fff;
        }
        
        .btn-light {
            background-color: white;
            border-color: #ddd;
        }
        
        .btn-light:hover {
            background-color: #f8f9fa;
            border-color: #ccc;
        }
        
        .table-dark {
            background-color: var(--neutral-900);
        }

        .report-chart-placeholder {
            min-height: 320px;
            border: 1px dashed #ced4da;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            padding: 1rem;
            text-align: center;
        }

        .report-text-box {
            min-height: 320px;
            border: var(--card-border);
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #fff;
            overflow-y: auto;
        }

        .report-meta {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .report-article {
            background: linear-gradient(145deg, #ffffff 0%, #f6f9fc 100%);
            border: 1px solid #e6ecf3;
            border-radius: 0.75rem;
            padding: 1.25rem;
            box-shadow: 0 0.75rem 1.25rem rgba(0,0,0,0.05);
        }

        .report-hero {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .report-type-badge {
            background: #0d6efd;
            color: #fff;
            padding: 0.35rem 0.75rem;
            border-radius: 999px;
            font-weight: 600;
            letter-spacing: 0.3px;
            box-shadow: 0 0.5rem 1rem rgba(13, 110, 253, 0.2);
        }

        .headline-chip {
            background: #e9f3ff;
            color: #1b4f72;
            padding: 0.35rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d0e4ff;
        }

        .report-body p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
            color: #1f2d3d;
        }

        .report-body h1, .report-body h2, .report-body h3 {
            color: #1a365d;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .report-body h1 { font-size: 1.4rem; border-left: 4px solid #0d6efd; padding-left: 0.5rem; }
        .report-body h2 { font-size: 1.25rem; border-left: 3px solid #2b6cb0; padding-left: 0.45rem; }
        .report-body h3 { font-size: 1.1rem;  border-left: 3px solid #3182ce; padding-left: 0.4rem; }

        .report-body ul { padding-left: 1.1rem; }
        .report-body li { margin-bottom: 0.3rem; }

        .report-figure {
            background: #ffffff;
            border: 1px solid #e1e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            box-shadow: 0 0.75rem 1.25rem rgba(0,0,0,0.04);
            margin: 1rem 0;
            min-height: 340px;
            overflow: hidden;
            position: relative;
        }

        .report-figure img {
            width: 100%;
            border-radius: 0.4rem;
        }

        .report-figure figcaption {
            margin-top: 0.4rem;
            font-size: 0.9rem;
            color: #4f5b66;
        }

        .report-figure canvas {
            display: block;
            width: 100% !important;
            max-height: 360px;
        }

        .figure-title {
            font-weight: 700;
            color: #1a365d;
            margin-bottom: 0.4rem;
        }

        .metric-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.6rem;
            border-radius: 0.6rem;
            background: #0d6efd;
            color: #fff;
            font-weight: 600;
            box-shadow: 0 0.5rem 1rem rgba(13, 110, 253, 0.2);
            margin-right: 0.35rem;
            margin-bottom: 0.35rem;
        }

        .metric-chip .delta {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .metric-pill {
            border-radius: 0.6rem;
            padding: 0.6rem 0.75rem;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            margin-bottom: 0.5rem;
        }

        .metric-pill strong {
            display: block;
            color: #1e293b;
        }

        .workspace-tabs .nav-link {
            border-radius: 999px;
            padding: 0.55rem 1.1rem;
            font-weight: 600;
        }

        .workspace-tabs .nav-link.active {
            background: #0d6efd;
            color: #fff;
            box-shadow: 0 0.5rem 1rem rgba(13, 110, 253, 0.15);
        }

        /* CPI tab idle color暖橙 */
        #cpi-tab.nav-link {
            color: #c2410c;
        }
        #cpi-tab.nav-link.active {
            background: #f59e0b;
            color: #fff;
            box-shadow: 0 0.5rem 1rem rgba(245, 158, 11, 0.25);
        }

        .report-sidebar {
            gap: 0.6rem;
        }

        .report-nav .list-group-item {
            border: none;
            padding: 0.6rem 0.75rem;
        }

        .report-nav .list-group-item:hover {
            background: #f4f6fa;
        }

        .report-figure,
        .report-article,
        #indicatorSummaryBlock {
            scroll-margin-top: 80px;
        }

        .indicator-summary-card .card-body {
            padding: 0.75rem 0.9rem;
        }

        .summary-list {
            display: flex;
            flex-direction: column;
            gap: 0.55rem;
        }

        .summary-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.55rem 0.75rem;
            background: linear-gradient(160deg, #ffffff, #f6f8fb);
            box-shadow: 0 4px 10px rgba(0,0,0,0.025);
        }

        .summary-title {
            font-weight: 650;
            color: #1f2937;
            font-size: 0.9rem;
        }

        .summary-value {
            font-size: 1rem;
            color: #0f172a;
        }

        .summary-meta {
            color: #6b7280;
            font-size: 0.8rem;
        }

        .summary-link {
            font-size: 0.78rem;
        }

        .contrib-table-wrapper {
            margin-top: 0.75rem;
        }

        .contrib-table th, .contrib-table td {
            vertical-align: middle;
            font-size: 0.9rem;
        }

        .contrib-table .major-row {
            font-weight: 700;
            background: #fff9e6;
        }

        .contrib-table .delta-pos {
            color: #16a34a;
        }

        .contrib-table .delta-neg {
            color: #dc2626;
        }

        .bar-cell {
            width: clamp(72px, 18vw, 96px);
        }

        .bar-track {
            height: 12px;
            background: #f1f5f9;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            margin-top: 4px;
            width: 100%;
            max-width: 90px;
        }

        .bar-fill {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 0;
            border-radius: 8px;
        }

        .bar-fill.pos {
            background: linear-gradient(90deg, #fdba74, #f97316); /* 上升：橙色 */
        }

        .bar-fill.neg {
            background: linear-gradient(90deg, #bae6fd, #0ea5e9); /* 下降：青蓝 */
            right: 50%;
        }

        .tree-toggle {
            border: none;
            background: none;
            color: #c2410c;
            padding: 0 4px 0 0;
            font-size: 0.9rem;
            line-height: 1;
        }

        .tree-indent {
            border-left: 1px dashed #e2e8f0;
            padding-left: 8px;
        }

        .tree-leaf-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #cbd5e1;
            display: inline-block;
            margin-right: 6px;
        }

        .heat-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 10px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
        }

        .heat-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        /* CPI 专区色彩统一（暖橙 + 海蓝） */
        #cpiArticle h1 { color: #b45309; border-left: 4px solid #ea580c; padding-left: 0.5rem; }
        #cpiArticle h2 { color: #c2410c; border-left: 3px solid #f59e0b; padding-left: 0.45rem; }
        #cpiArticle h3 { color: #d97706; border-left: 3px solid #f59e0b; padding-left: 0.4rem; }
        #cpiArticle .figure-title { color: #b45309; }
        #cpiArticle .report-figure { border-color: #fcd34d; background: #ffffff; }
        #cpiArticle .headline-chip { background: #fff4e6; color: #9a3412; border: 1px solid #fcd34d; }
        #cpiArticle .metric-chip { background: #fff1e0; color: #9a3412; box-shadow: 0 0.5rem 1rem rgba(244,143,66,0.15); }

        .nav-label {
            display: block;
            font-weight: 600;
            color: #1f2937;
        }

        .nav-sub {
            display: block;
            color: #6b7280;
            font-size: 0.82rem;
        }

        .report-tabs .nav-link {
            font-weight: 600;
        }

        .report-tabs .badge {
            font-size: 0.65rem;
        }
        
        /* 响应式设计增强 */
        @media (max-width: 768px) {
            .header {
                padding: 1rem 0;
                text-align: center;
            }
            
            .header h1 {
                font-size: 1.75rem;
            }
            
            .filter-section {
                padding: 1rem;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .data-table-container {
                max-height: 300px;
            }
            
            .footer {
                text-align: center;
            }
            
            /* 在小屏幕上改为垂直布局 */
            .sidebar-col {
                margin-bottom: 1.5rem;
            }
        }

        @media (min-width: 992px) {
            .report-sidebar {
                position: sticky;
                top: 88px;
                max-height: calc(100vh - 96px);
                overflow-y: auto;
                padding-right: 0.15rem;
            }
        }
        
        @media (max-width: 576px) {
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .filter-section .row > div {
                margin-bottom: 1rem;
            }
            
            .filter-section .row > div:last-child {
                margin-bottom: 0;
            }
            
            .chart-container {
                height: 250px;
            }
            
            .card-body {
                padding: 1rem;
            }
        }
        
        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 滚动条样式 */
        .data-table-container::-webkit-scrollbar, .indicator-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .data-table-container::-webkit-scrollbar-track, .indicator-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .data-table-container::-webkit-scrollbar-thumb, .indicator-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .data-table-container::-webkit-scrollbar-thumb:hover, .indicator-list::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* 折叠图标动画 */
        .collapse-icon {
            transition: transform 0.3s ease;
        }
        
        .collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-bar-chart-line"></i> FOMC宏观数据情报工作台</h1>
                    <p class="mb-0">面向公开市场委员会的宏观指标监测与研判平台</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <button class="btn btn-outline-primary" id="refreshBtn" style="border-color: var(--teal-600); color: var(--teal-600);">
                        <i class="bi bi-arrow-repeat"></i> 刷新数据
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="card workspace-card mb-4">
            <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center justify-content-between">
                <div>
                    <div class="text-uppercase text-muted small fw-semibold mb-1">Workspace</div>
                    <h5 class="mb-1">数据浏览与研报分区</h5>
                    <p class="text-muted mb-0">从经济数据库浏览指标，或切换到研报工作台进行专题解读。</p>
                </div>
                <ul class="nav nav-pills workspace-tabs mt-3 mt-lg-0" id="workspaceTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="data-tab" data-bs-toggle="tab" data-bs-target="#dataWorkspace" type="button" role="tab" aria-controls="dataWorkspace" aria-selected="true">
                            经济数据浏览
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="report-tab" data-bs-toggle="tab" data-bs-target="#reportWorkspace" type="button" role="tab" aria-controls="reportWorkspace" aria-selected="false">
                            研报工作台
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <div class="tab-content" id="workspaceTabContent">
            <div class="tab-pane fade show active" id="dataWorkspace" role="tabpanel" aria-labelledby="data-tab">
                <div class="row">
                    <!-- 左侧指标选择区 -->
                    <div class="col-lg-3 sidebar-col">
                        <div class="card">
                            <div class="card-header text-white" style="background: linear-gradient(135deg, var(--teal-600), #128c7e);">
                                <h5 class="mb-0"><i class="bi bi-list-ul"></i> 经济指标分类</h5>
                            </div>
                            <div class="card-body">
                                <div id="indicatorHierarchy">
                                    <!-- 动态填充指标层级结构 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 过滤器区域 -->
                        <div class="card mt-3">
                            <div class="card-header text-white" style="background: linear-gradient(135deg, #128c7e, #0f766e);">
                                <h5 class="mb-0"><i class="bi bi-funnel"></i> 数据过滤器</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="dateRange" class="form-label">时间范围</label>
                                    <select class="form-select" id="dateRange">
                                        <option value="1Y">最近1年</option>
                                        <option value="3Y" selected>最近3年</option>
                                        <option value="5Y">最近5年</option>
                                        <option value="10Y">最近10年</option>
                                        <option value="all">全部数据</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="sortOrder" class="form-label">排序方式</label>
                                    <select class="form-select" id="sortOrder">
                                        <option value="date_desc">按日期降序</option>
                                        <option value="date_asc">按日期升序</option>
                                        <option value="value_desc">按数值降序</option>
                                        <option value="value_asc">按数值升序</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧数据展示区 -->
                    <div class="col-lg-9">
                        <!-- 图表区域 -->
                        <div class="card">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> 数据趋势图</h5>
                                    <small id="currentIndicator" class="text-white-50">请选择一个经济指标</small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-light me-2" id="lineChartBtn">折线图</button>
                                    <button class="btn btn-sm btn-light" id="barChartBtn">柱状图</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="dataChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- 数据表格 -->
                        <div class="card">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="bi bi-table"></i> 数据表格</h5>
                            </div>
                            <div class="card-body">
                                <div class="data-table-container">
                                    <table class="table table-striped table-hover" id="dataTable">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>指标名称</th>
                                                <th>日期</th>
                                                <th>数值</th>
                                                <th>单位</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- 动态填充数据行 -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="reportWorkspace" role="tabpanel" aria-labelledby="report-tab">
                <div class="card mb-4">
                    <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-md-center">
                        <div>
                            <h5 class="mb-1"><i class="bi bi-journal-text"></i> 研报工作台</h5>
                            <p class="text-muted mb-0">基于经济数据库，分专题生成劳动力市场与通胀的可视化研判。</p>
                        </div>
                        <div class="mt-3 mt-md-0 text-muted small">
                            数据与图表来源于本地数据库，文字由 DeepSeek LLM 生成
                        </div>
                    </div>
                </div>

                <ul class="nav nav-tabs report-tabs" id="reportTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="nonfarm-tab" data-bs-toggle="tab" data-bs-target="#nonfarmReport" type="button" role="tab" aria-controls="nonfarmReport" aria-selected="true">
                            非农就业研判
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="cpi-tab" data-bs-toggle="tab" data-bs-target="#cpiReport" type="button" role="tab" aria-controls="cpiReport" aria-selected="false">
                            通胀（CPI）研判
                        </button>
                    </li>
                </ul>

                <div class="tab-content pt-3" id="reportTabContent">
                    <div class="tab-pane fade show active" id="nonfarmReport" role="tabpanel" aria-labelledby="nonfarm-tab">
                        <div class="row g-4">
                            <div class="col-12 col-lg-4 col-xl-3">
                                <div class="report-sidebar d-flex flex-column">
                                        <div class="card">
                                        <div class="card-header text-white" style="background: linear-gradient(135deg, var(--blue-700), var(--blue-500));">
                                            <h5 class="mb-1"><i class="bi bi-clipboard2-pulse"></i> 非农就业形势研判</h5>
                                            <small class="text-white-50">选择月份后，系统会绘制图表并生成文字分析</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="reportMonth" class="form-label">报告月份</label>
                                                <input type="month" class="form-control" id="reportMonth">
                                            </div>
                                            <div class="d-flex flex-column gap-2">
                                                <div class="d-flex flex-column flex-md-row gap-2">
                                                    <button class="btn btn-nonfarm flex-grow-1" id="generateReportBtn">
                                                        <i class="bi bi-play-circle"></i> 生成图表与研报
                                                    </button>
                                                    <button class="btn btn-nonfarm-outline flex-grow-1" id="exportPdfBtn" disabled>
                                                        <i class="bi bi-file-earmark-pdf"></i> 导出PDF
                                                    </button>
                                                </div>
                                                <div id="reportStatus" class="report-meta text-md-end">请选择月份后点击生成。</div>
                                            </div>
                                            <div class="mt-3 small text-muted">
                                                输出内容聚焦美联储关注的就业增速、失业率结构与劳动力参与率。
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card report-nav">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0"><i class="bi bi-map"></i> 研报导航</h6>
                                        </div>
                                        <div class="list-group list-group-flush" id="reportNavList">
                                            <div class="list-group-item text-muted small">生成研报后显示章节</div>
                                        </div>
                                    </div>
                                    <div class="card indicator-summary-card" id="indicatorSummaryBlock">
                                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="bi bi-stars"></i> 关键经济指标</h6>
                                            <span class="text-muted small">最新</span>
                                        </div>
                                        <div class="card-body">
                                            <div id="indicatorSummary" class="summary-list">
                                                <div class="text-muted small">暂无数据，请先生成一次研报。</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-lg-8 col-xl-9">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="report-article" id="reportArticle">
                                            <div class="report-hero">
                                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                                    <span class="report-type-badge">非农就业研判</span>
                                                    <span class="headline-chip" id="reportHeadlineBadge">待生成</span>
                                                </div>
                                                <div class="metric-chip" id="reportWindow">近期区间</div>
                                            </div>
                                            <div class="report-body" id="reportText">
                                                <p class="text-muted">生成研报后，将呈现图文并茂的结构化解读。</p>
                                            </div>
                                            <figure class="report-figure mt-3" id="figure1">
                                                <div class="figure-title">图1：新增非农就业（万人）及失业率(%，右)</div>
                                                <canvas id="reportChart1" height="320"></canvas>
                                            </figure>
                                            <figure class="report-figure" id="figure2">
                                                <div class="figure-title">图2：分行业新增非农就业贡献率(%)</div>
                                                <canvas id="reportChart2" height="360"></canvas>
                                            </figure>
                                            <figure class="report-figure" id="figure3">
                                                <div class="figure-title">图3：各类型失业率(%)</div>
                                                <canvas id="reportChart3" height="320"></canvas>
                                            </figure>
                                            <figure class="report-figure" id="figure4">
                                                <div class="figure-title">图4：就业率和劳动参与率(%)</div>
                                                <canvas id="reportChart4" height="320"></canvas>
                                            </figure>
                                            <div id="llmError" class="text-danger small mt-2 d-none"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="cpiReport" role="tabpanel" aria-labelledby="cpi-tab">
                        <div class="row g-4">
                            <div class="col-12 col-lg-4 col-xl-3">
                                <div class="report-sidebar d-flex flex-column">
                                    <div class="card">
                                        <div class="card-header text-white" style="background: linear-gradient(135deg, var(--orange-700), var(--orange-500));">
                                            <h5 class="mb-1"><i class="bi bi-thermometer-sun"></i> CPI 通胀研判</h5>
                                            <small class="text-white-50">选择月份后生成同比/环比走势与拉动表</small>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="cpiReportMonth" class="form-label">报告月份</label>
                                                <input type="month" class="form-control" id="cpiReportMonth">
                                            </div>
                                            <div class="d-flex flex-column gap-2">
                                                <div class="d-flex flex-column flex-md-row gap-2">
                                                    <button class="btn btn-cpi flex-grow-1" id="generateCpiBtn">
                                                        <i class="bi bi-play-circle"></i> 生成CPI图表与研判
                                                    </button>
                                                    <button class="btn btn-cpi-outline flex-grow-1" id="exportCpiPdfBtn" disabled>
                                                        <i class="bi bi-file-earmark-pdf"></i> 导出PDF
                                                    </button>
                                                </div>
                                                <div id="cpiStatus" class="report-meta text-md-end text-end">请选择月份后生成。</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card report-nav mt-3">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0"><i class="bi bi-map"></i> 研报导航</h6>
                                        </div>
                                        <div class="list-group list-group-flush" id="cpiNavList">
                                            <div class="list-group-item text-muted small">生成研报后显示章节</div>
                                        </div>
                                    </div>
                                    <div class="card indicator-summary-card mt-3">
                                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="bi bi-stars"></i> 关键通胀指标</h6>
                                            <span class="text-muted small">最新</span>
                                        </div>
                                        <div class="card-body">
                                            <div id="cpiIndicatorList" class="summary-list">
                                                <div class="text-muted small">暂无数据，请先生成一次研报。</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card">
                                        <div class="card-body small text-muted">
                                            权重采用近似相对重要性（食品、能源、核心商品、核心服务），用于估算拉动贡献，后续可按年度更新。
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-lg-8 col-xl-9">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="report-article" id="cpiArticle">
                                            <div class="report-hero">
                                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                                    <span class="report-type-badge" style="background:#f59e0b;">通胀（CPI）研判</span>
                                                    <span class="headline-chip" id="cpiHeadlineBadge">待生成</span>
                                                </div>
                                                <div class="metric-chip" id="cpiWindowChip" style="background:#fff4e6;color:#9a3412;border:1px solid #fcd34d;">近期区间</div>
                                            </div>
                                            <div class="report-body" id="cpiReportText">
                                                <p class="text-muted">生成CPI研报后，将呈现结构化解读与图表/表格。</p>
                                            </div>
                                            <figure class="report-figure mt-3" id="cpiFigure1">
                                                <div class="figure-title">图1：美国CPI、核心CPI当月同比(%)</div>
                                                <canvas id="cpiChartYoy" height="320"></canvas>
                                            </figure>
                                            <figure class="report-figure" id="cpiFigure2">
                                                <div class="figure-title">图2：CPI、核心CPI季调环比（%）</div>
                                                <canvas id="cpiChartMom" height="320"></canvas>
                                            </figure>
                                            <div class="table-responsive contrib-table-wrapper" id="cpiYoyWrapper">
                                                <div class="figure-title">表1：当月CPI同比拉动拆分</div>
                                                <table class="table table-hover contrib-table">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>分项</th>
                                                            <th>权重(%)</th>
                                                            <th>本月同比(%)</th>
                                                            <th>拉动(ppts)</th>
                                                            <th>上月同比(%)</th>
                                                            <th>上月拉动(ppts)</th>
                                                            <th>拉动差异(ppts)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="cpiYoyTableBody">
                                                        <tr><td colspan="7" class="text-center text-muted py-3">等待生成</td></tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="table-responsive contrib-table-wrapper" id="cpiMomWrapper">
                                                <div class="figure-title">表2：当月季调CPI分项环比结构</div>
                                                <table class="table table-hover contrib-table">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>分项</th>
                                                            <th>权重(%)</th>
                                                            <th>本月环比(%)</th>
                                                            <th>拉动(ppts)</th>
                                                            <th>上月环比(%)</th>
                                                            <th>上月拉动(ppts)</th>
                                                            <th>拉动差异(ppts)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="cpiMomTableBody">
                                                        <tr><td colspan="7" class="text-center text-muted py-3">等待生成</td></tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div id="cpiLlmError" class="text-danger small mt-2 d-none"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0">&copy; 2025 FOMC宏观数据情报工作台</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">数据来源: Federal Reserve Economic Data (FRED)</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let currentChart = null;
        let chartType = 'line'; // 默认图表类型
        let activeIndicatorId = null; // 当前选中的指标ID
        let lastReportData = null; // 最新的研报数据用于导出
        let lastCpiReportData = null;
        let cpiChartYoy = null;
        let cpiChartMom = null;
        let contribCollapseState = { yoy: null, mom: null };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadIndicators();
            loadDataTable();
            initializeChart();
            initializeReportModule();
            initializeCpiModule();
            
            // 绑定事件监听器
            document.getElementById('dateRange').addEventListener('change', updateVisualization);
            document.getElementById('sortOrder').addEventListener('change', updateVisualization);
            document.getElementById('lineChartBtn').addEventListener('click', function() {
                chartType = 'line';
                updateVisualization();
            });
            document.getElementById('barChartBtn').addEventListener('click', function() {
                chartType = 'bar';
                updateVisualization();
            });
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
        });

        // 显示消息
        function showMessage(message, type) {
            // 移除现有的消息
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // 创建新的消息元素
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // 插入到页面顶部
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            // 3秒后自动消失
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // 显示加载状态
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                // 特殊处理表格元素
                if (elementId === 'dataTable') {
                    const tbody = element.querySelector('tbody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4"><div class="loading mx-auto"></div><p class="mt-2">加载中...</p></td></tr>';
                    }
                } else {
                    element.innerHTML = '<div class="text-center py-4"><div class="loading mx-auto"></div><p class="mt-2">加载中...</p></div>';
                }
            }
        }

        // 显示错误信息
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                // 特殊处理表格元素
                if (elementId === 'dataTable') {
                    const tbody = element.querySelector('tbody');
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger py-4">加载失败: ${message}</td></tr>`;
                    }
                } else {
                    element.innerHTML = `<div class="alert alert-danger text-center py-4">加载失败: ${message}</div>`;
                }
            }
        }

        // 加载经济指标列表的层级结构
        function loadIndicators() {
            fetch('/api/indicators')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    const hierarchyContainer = document.getElementById('indicatorHierarchy');
                    hierarchyContainer.innerHTML = '';
                    
                    // 递归函数，用于构建层级结构的HTML
                    function buildHierarchyHTML(items, level = 0) {
                        let html = '';
                        items.forEach(item => {
                            if (item.type === 'category') {
                                const categoryId = `category-${item.id}`;
                                const iconClass = level === 0 ? 'bi-folder-fill' : 'bi-folder2-open';
                                const paddingStyle = level > 0 ? `style="padding-left: ${level * 10}px"` : '';
                                
                                html += `
                                    <div class="indicator-category mb-2" ${paddingStyle}>
                                        <div class="category-header" data-bs-toggle="collapse" data-bs-target="#${categoryId}">
                                            <span><i class="bi ${iconClass} me-2"></i>${item.name}</span>
                                            <i class="bi bi-chevron-down collapse-icon"></i>
                                        </div>
                                        <div class="collapse show indicator-list" id="${categoryId}">
                                            ${item.children && item.children.length > 0 ? buildHierarchyHTML(item.children, level + 1) : ''}
                                        </div>
                                    </div>
                                `;
                            } else if (item.type === 'indicator') {
                                const paddingStyle = `style="padding-left: ${(level + 1) * 10}px"`;
                                html += `
                                    <div class="indicator-item" data-id="${item.id}" data-fred-url="${item.fred_url}" ${paddingStyle}>
                                        <div class="fw-bold">${item.name}</div>
                                        <small class="text-muted">${item.code}</small>
                                        <div class="mt-1">
                                            <a href="${item.fred_url}" target="_blank" class="fred-link text-primary" style="font-size: 0.75rem;">
                                                <i class="bi bi-box-arrow-up-right"></i> FRED数据
                                            </a>
                                        </div>
                                    </div>
                                `;
                            }
                        });
                        return html;
                    }
                    
                    // 构建并插入层级结构HTML
                    hierarchyContainer.innerHTML = buildHierarchyHTML(data);
                    
                    // 为所有指标项添加点击事件
                    document.querySelectorAll('.indicator-item').forEach(item => {
                        item.addEventListener('click', () => selectIndicator(item.dataset.id));
                    });
                })
                .catch(error => {
                    console.error('加载指标列表失败:', error);
                    const hierarchyContainer = document.getElementById('indicatorHierarchy');
                    hierarchyContainer.innerHTML = `<div class="alert alert-danger">加载指标列表失败: ${error.message}</div>`;
                });
        }

        // 加载数据表格
        function loadDataTable() {
            showLoading('dataTable');
            fetch('/api/data')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    const tbody = document.querySelector('#dataTable tbody');
                    tbody.innerHTML = '';
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center">暂无数据</td></tr>';
                        return;
                    }
                    data.forEach(point => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${point.indicator_name}</td>
                            <td>${point.date}</td>
                            <td>${point.value}</td>
                            <td>${point.units}</td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('加载数据表格失败:', error);
                    const tbody = document.querySelector('#dataTable tbody');
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">加载失败: ${error.message}</td></tr>`;
                });
        }

        // 初始化图表
        function initializeChart() {
            const ctx = document.getElementById('dataChart').getContext('2d');
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '经济指标数据',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // 更新可视化
        function updateVisualization() {
            const indicatorId = activeIndicatorId;
            const dateRange = document.getElementById('dateRange').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            // 如果没有选中任何指标，则不更新
            if (!indicatorId) {
                return;
            }
            
            // 显示图表加载状态
            if (currentChart) {
                currentChart.destroy();
            }
            const chartCtx = document.getElementById('dataChart').getContext('2d');
            currentChart = new Chart(chartCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '加载中...',
                        data: [],
                        borderColor: 'rgba(0, 0, 0, 0.1)',
                        backgroundColor: 'rgba(0, 0, 0, 0.05)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
            
            // 显示表格加载状态
            showLoading('dataTable');
            
            // 更新图表
            fetch(`/api/chart-data?indicator_id=${indicatorId}&date_range=${dateRange}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    if (currentChart) {
                        currentChart.destroy();
                    }
                    
                    const ctx = document.getElementById('dataChart').getContext('2d');
                    // 构建包含单位的图表标题
                    const chartTitle = data.indicator_units ? 
                        `${data.indicator_name} (${data.indicator_units})` : 
                        data.indicator_name;
                    
                    currentChart = new Chart(ctx, {
                        type: chartType,
                        data: {
                            labels: data.dates,
                            datasets: [{
                                label: chartTitle,
                                data: data.values,
                                borderColor: 'rgb(54, 162, 235)',
                                backgroundColor: chartType === 'line' ? 'rgba(54, 162, 235, 0.2)' : 'rgba(54, 162, 235, 0.6)',
                                tension: 0.1,
                                fill: chartType === 'line'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    labels: {
                                        font: {
                                            size: 14
                                        }
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                    titleFont: {
                                        size: 14
                                    },
                                    bodyFont: {
                                        size: 13
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('更新图表失败:', error);
                    if (currentChart) {
                        currentChart.destroy();
                    }
                    const ctx = document.getElementById('dataChart').getContext('2d');
                    currentChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: '加载失败',
                                data: [],
                                borderColor: 'rgba(255, 0, 0, 0.5)',
                                backgroundColor: 'rgba(255, 0, 0, 0.1)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    });
                });
            
            // 更新表格
            fetch(`/api/data?indicator_id=${indicatorId}&date_range=${dateRange}&sort_order=${sortOrder}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    const tbody = document.querySelector('#dataTable tbody');
                    tbody.innerHTML = '';
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center">暂无数据</td></tr>';
                        return;
                    }
                    data.forEach(point => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${point.indicator_name}</td>
                            <td>${point.date}</td>
                            <td>${point.value}</td>
                            <td>${point.units}</td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('更新数据表格失败:', error);
                    const tbody = document.querySelector('#dataTable tbody');
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">加载失败: ${error.message}</td></tr>`;
                });
        }

        // 选择指标
        function selectIndicator(indicatorId) {
            // 更新活动状态
            activeIndicatorId = indicatorId;
            
            // 更新UI上的活动状态
            document.querySelectorAll('.indicator-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const selectedItem = document.querySelector(`.indicator-item[data-id="${indicatorId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
            
            // 获取指标名称并显示在页面上
            const indicatorName = selectedItem.querySelector('.fw-bold').textContent;
            const indicatorCode = selectedItem.querySelector('.text-muted').textContent;
            const fredUrl = selectedItem.dataset.fredUrl;
            
            // 更新当前选中的指标显示，添加FRED链接
            const currentIndicatorElement = document.getElementById('currentIndicator');
            if (currentIndicatorElement) {
                currentIndicatorElement.innerHTML = `${indicatorName} (${indicatorCode}) <a href="${fredUrl}" target="_blank" class="text-white-50 ms-2" style="font-size: 0.8rem;"><i class="bi bi-box-arrow-up-right"></i> FRED</a>`;
            }
            
            // 更新可视化
            updateVisualization();
        }

        // 刷新数据
        function refreshData() {
            // 显示刷新状态
            const refreshBtn = document.getElementById('refreshBtn');
            const originalText = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 刷新中...';
            refreshBtn.disabled = true;
            
            fetch('/api/refresh-data', { method: 'POST' })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    // 显示成功消息
                    showMessage(data.message, 'success');
                    loadIndicators();
                    loadDataTable();
                    updateVisualization();
                })
                .catch(error => {
                    console.error('刷新数据失败:', error);
                    showMessage('数据刷新失败: ' + error.message, 'danger');
                })
                .finally(() => {
                    // 恢复按钮状态
                    setTimeout(() => {
                        refreshBtn.innerHTML = originalText;
                        refreshBtn.disabled = false;
                    }, 1000);
                });
        }

        // -------------------------------
        // 研报生成相关逻辑
        // -------------------------------
        function initializeReportModule() {
            const monthInput = document.getElementById('reportMonth');
            if (monthInput) {
                const now = new Date();
                const monthValue = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                monthInput.value = monthValue;
            }
            const generateBtn = document.getElementById('generateReportBtn');
            if (generateBtn) {
                generateBtn.addEventListener('click', handleReportGeneration);
            }
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            if (exportPdfBtn) {
                exportPdfBtn.addEventListener('click', handlePdfExport);
            }
            setExportEnabled(false);
        }

        function handleReportGeneration() {
            const reportMonth = document.getElementById('reportMonth').value;
            if (!reportMonth) {
                showMessage('请先选择报告月份', 'warning');
                return;
            }
            lastReportData = null;
            setExportEnabled(false);
            setReportLoading(true, '正在生成图表与研报...');
            fetch('/api/labor-market/report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ report_month: reportMonth })
            })
            .then(response => response.json().then(data => {
                if (!response.ok) {
                    throw new Error(data.error || '生成失败');
                }
                return data;
            }))
            .then(data => {
                updateReportUI(data);
            })
            .catch(error => {
                console.error('生成研报失败:', error);
                showMessage('生成研报失败: ' + error.message, 'danger');
                setReportLoading(false, '生成失败，请重试');
            });
        }

        function setExportEnabled(isEnabled) {
            const btnPdf = document.getElementById('exportPdfBtn');
            if (btnPdf) btnPdf.disabled = !isEnabled;
        }

        function handlePdfExport() {
            if (!lastReportData) {
                showMessage('请先生成研报，再尝试导出', 'info');
                return;
            }
            const btn = document.getElementById('exportPdfBtn');
            const original = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> 生成PDF...';
            }
            fetch('/api/labor-market/report.pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ report_data: lastReportData })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => { throw new Error(data.error || '导出失败'); });
                }
                return response.blob();
            })
            .then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const month = lastReportData.report_month || 'report';
                a.href = url;
                a.download = `非农就业研判_${month}.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                showMessage('PDF 导出完成', 'success');
            })
            .catch(error => {
                console.error('导出PDF失败:', error);
                showMessage('导出PDF失败: ' + error.message, 'danger');
            })
            .finally(() => {
                if (btn) {
                    btn.innerHTML = original || '<i class="bi bi-file-earmark-pdf"></i> 导出PDF';
                    setExportEnabled(!!lastReportData);
                }
            });
        }

        function setReportLoading(isLoading, statusText) {
            const button = document.getElementById('generateReportBtn');
            const status = document.getElementById('reportStatus');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            if (button) {
                if (isLoading) {
                    button.disabled = true;
                    button.innerHTML = '<span class="loading"></span> 处理中...';
                } else {
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-play-circle"></i> 生成图表与研报';
                }
            }
            if (exportPdfBtn) exportPdfBtn.disabled = !!isLoading;
            if (status && statusText) {
                status.textContent = statusText;
            } else if (status && !isLoading) {
                status.textContent = '生成完成，可重新选择月份。';
            }
        }

        function updateReportUI(data) {
            const windowInfo = data.chart_window;
            const windowText = windowInfo ? `图表区间：${windowInfo.start_date} - ${windowInfo.end_date}` : '生成完成';
            setReportLoading(false, windowText);
            lastReportData = data;
            setExportEnabled(true);
            updateReportHero(data.headline_summary, windowText);
            renderReportContent(
                data.report_text,
                {
                    labor: data.chart_image,
                    unemploymentTypes: data.unemployment_types_chart
                },
                data
            );
            updateIndicatorSummary(data.indicators, data.unemployment_types_series);
            handleLLMError(data.llm_error);
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        function formatInline(text) {
            // Very small inline formatter: bold (**text**) and italic (*text*)
            const escaped = escapeHtml(text);
            return escaped
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>');
        }

        function renderMarkdown(mdText) {
            // Basic Markdown rendering for headings + lists + paragraphs.
            const lines = (mdText || '').split(/\r?\n/);
            const html = [];
            let listBuffer = [];
            let listType = null; // 'ul' or 'ol'

            function flushList() {
                if (listBuffer.length === 0) return;
                const tag = listType === 'ol' ? 'ol' : 'ul';
                html.push(`<${tag}>${listBuffer.map(item => `<li>${item}</li>`).join('')}</${tag}>`);
                listBuffer = [];
                listType = null;
            }

            lines.forEach(rawLine => {
                const line = rawLine.trim();
                if (!line) {
                    flushList();
                    return;
                }

                const headingMatch = line.match(/^(#{1,6})\s+(.*)/);
                if (headingMatch) {
                    flushList();
                    const level = Math.min(headingMatch[1].length, 3); // clamp to h3 for UI
                    html.push(`<h${level}>${formatInline(headingMatch[2])}</h${level}>`);
                    return;
                }

                const bulletMatch = line.match(/^[-*+]\s+(.*)/);
                if (bulletMatch) {
                    if (listType && listType !== 'ul') flushList();
                    listType = 'ul';
                    listBuffer.push(formatInline(bulletMatch[1]));
                    return;
                }

                const orderedMatch = line.match(/^\d+\.\s+(.*)/);
                if (orderedMatch) {
                    if (listType && listType !== 'ol') flushList();
                    listType = 'ol';
                    listBuffer.push(formatInline(orderedMatch[1]));
                    return;
                }

                flushList();
                html.push(`<p>${formatInline(line)}</p>`);
            });

            flushList();
            return html.join('\n');
        }

        function stripCodeFence(mdText) {
            if (!mdText) return '';
            const fenceRegex = /^```[a-zA-Z0-9]*\s*([\s\S]*?)\s*```$/;
            const match = mdText.trim().match(fenceRegex);
            return match ? match[1].trim() : mdText;
        }

        function stripMarkdownTables(mdText) {
            if (!mdText) return '';
            const lines = mdText.split(/\r?\n/);
            const filtered = lines.filter(line => {
                const pipes = (line.match(/\|/g) || []).length;
                // Remove table header/rows
                if (pipes >= 2) return false;
                // Remove typical separator rows
                if (/^\s*[-|: ]+\|[-|: ]+/.test(line)) return false;
                return true;
            });
            return filtered.join('\n');
        }

        function updateReportHero(headline, windowText) {
            const badgeEl = document.getElementById('reportHeadlineBadge');
            const windowChip = document.getElementById('reportWindow');
            if (badgeEl && headline) {
                badgeEl.textContent = headline;
            }
            if (windowChip && windowText) {
                windowChip.textContent = windowText;
            }
        }

        let reportChart1 = null;
        let reportChart2 = null;
        let reportChart3 = null;
        let reportChart4 = null;

        function destroyReportCharts() {
            if (reportChart1) {
                reportChart1.destroy();
                reportChart1 = null;
            }
            if (reportChart2) {
                reportChart2.destroy();
                reportChart2 = null;
            }
            if (reportChart3) {
                reportChart3.destroy();
                reportChart3 = null;
            }
            if (reportChart4) {
                reportChart4.destroy();
                reportChart4 = null;
            }
        }

        function resetReportCanvas(canvasId) {
            const existing = document.getElementById(canvasId);
            if (!existing) return null;
            const clone = existing.cloneNode(false);
            clone.height = existing.height || 320;
            existing.parentNode.replaceChild(clone, existing);
            return clone;
        }

        function renderReportContent(reportText, charts, rawData) {
            const container = document.getElementById('reportText');
            if (!container) return;
            container.innerHTML = '';

            if (!reportText) {
                const p = document.createElement('p');
                p.className = 'text-muted';
                p.textContent = '未能生成研报内容，请检查DeepSeek配置。';
                container.appendChild(p);
                updateReportNav([]);
                return;
            }

            const cleanedText = stripCodeFence(reportText);
            const contentWrapper = document.createElement('div');
            contentWrapper.innerHTML = renderMarkdown(cleanedText);

            // Pull figures and re-place so text (heading + paragraph) comes before image
            const fig1 = document.getElementById('reportChart1')?.closest('figure') || null;
            const fig2 = document.getElementById('reportChart2')?.closest('figure') || null;
            const fig3 = document.getElementById('reportChart3')?.closest('figure') || null;
            const fig4 = document.getElementById('reportChart4')?.closest('figure') || null;
            const figs = [fig1, fig2, fig3, fig4];
            figs.forEach(f => { if (f && f.parentNode) f.parentNode.removeChild(f); });

            const nodes = Array.from(contentWrapper.childNodes);
            const fragment = document.createDocumentFragment();
            nodes.forEach(node => fragment.appendChild(node));
            container.appendChild(fragment);

            function placeFigureAfterText(fig, label) {
                if (!fig) return;
                const children = Array.from(container.childNodes);
                for (let i = 0; i < children.length; i++) {
                    const node = children[i];
                    const text = (node.textContent || '').trim();
                    const isHeading = node.nodeType === 1 && /^H[1-3]$/i.test(node.tagName);
                    if (isHeading && text.includes(label)) {
                        for (let j = i + 1; j < children.length; j++) {
                            const nextNode = children[j];
                            if (nextNode.nodeType === 1 && /^(P|UL|OL)$/i.test(nextNode.tagName)) {
                                nextNode.parentNode.insertBefore(fig, nextNode.nextSibling);
                                return;
                            }
                            if (nextNode.nodeType === 1 && /^H[1-3]$/i.test(nextNode.tagName)) {
                                node.parentNode.insertBefore(fig, node.nextSibling);
                                return;
                            }
                        }
                        container.appendChild(fig);
                        return;
                    }
                }
                for (let i = 0; i < children.length; i++) {
                    const node = children[i];
                    if (node.nodeType === 1 && /^(P|UL|OL)$/i.test(node.tagName)) {
                        node.parentNode.insertBefore(fig, node.nextSibling);
                        return;
                    }
                }
                container.appendChild(fig);
            }

            placeFigureAfterText(fig1, '图1');
            placeFigureAfterText(fig2, '图2');
            placeFigureAfterText(fig3, '图3');
            placeFigureAfterText(fig4, '图4');

            renderReportCharts(rawData);

            // 生成导航：提取 h1/h2/h3
            const headings = Array.from(container.querySelectorAll('h1, h2, h3')).map((el, idx) => {
                // 确保有 id
                if (!el.id) {
                    const slug = `section-${idx}-${el.textContent.trim().replace(/\s+/g, '-').toLowerCase()}`;
                    el.id = slug;
                }
                return { id: el.id, text: el.textContent.trim(), level: el.tagName.toLowerCase() };
            });
            updateReportNav(headings);
        }

        function renderReportCharts(data) {
            if (!data) return;
            destroyReportCharts();
            const canvas1 = resetReportCanvas('reportChart1');
            const canvas2 = resetReportCanvas('reportChart2');
            const canvas3 = resetReportCanvas('reportChart3');
            const canvas4 = resetReportCanvas('reportChart4');

            if (canvas1) {
                const labels = (data.payems_series || []).map(p => p.date);
                const payemsValues = (data.payems_series || []).map(p => p.monthly_change_10k ?? p.value ?? null);
                const unrateMap = new Map((data.unemployment_series || []).map(u => [u.date, u.value]));
                const unrateValues = labels.map(d => unrateMap.get(d) ?? null);

                reportChart1 = new Chart(canvas1.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            {
                                type: 'bar',
                                label: '新增非农就业（万人）',
                                data: payemsValues,
                                backgroundColor: 'rgba(47, 120, 196, 0.6)',
                                yAxisID: 'y',
                            },
                            {
                                type: 'line',
                                label: '失业率(%)',
                                data: unrateValues,
                                borderColor: '#ff7f0e',
                                backgroundColor: 'rgba(255, 127, 14, 0.2)',
                                yAxisID: 'y1',
                                tension: 0.15,
                                pointRadius: 2,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'top', align: 'start' }
                        },
                        scales: {
                            y: { position: 'left', title: { display: true, text: '万人' } },
                            y1: { position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: '%'} }
                        },
                    },
                });
            }

            if (canvas2) {
                const contribution = data.industry_contribution || {};
                const labels = contribution.labels || [];
                const datasetsRaw = contribution.datasets || [];
                const hasData = Array.isArray(labels) && labels.length > 0 && Array.isArray(datasetsRaw) && datasetsRaw.length > 0;
                if (!hasData) {
                    const parent = canvas2.parentNode;
                    if (parent && !parent.querySelector('.figure-empty')) {
                        const holder = document.createElement('div');
                        holder.className = 'text-muted small figure-empty';
                        holder.textContent = contribution.error || '缺少分行业贡献率数据';
                        parent.appendChild(holder);
                    }
                } else {
                    const empty = canvas2.parentNode?.querySelector('.figure-empty');
                    if (empty) empty.remove();

                    const palette = [
                        '#1f77b4', '#52b788', '#f4a261', '#e63946', '#2a9d8f', '#6c63ff', '#ff7f50',
                        '#90be6d', '#d35d6e', '#5c7cfa', '#00b4d8', '#b07dac', '#7d8597', '#2c3e50'
                    ];
                    const reversedLabels = [...labels].reverse();
                    const datasets = datasetsRaw.map((d, idx) => ({
                        label: d.label,
                        data: [...(d.data || [])].reverse(),
                        backgroundColor: palette[idx % palette.length],
                        borderWidth: 0,
                        stack: 'total'
                    }));

                    reportChart2 = new Chart(canvas2.getContext('2d'), {
                        type: 'bar',
                        data: { labels: reversedLabels, datasets },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'top', align: 'start', labels: { boxWidth: 14, boxHeight: 14 } },
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) => {
                                            const val = ctx.raw;
                                            const formatted = val === null || val === undefined ? '—' : `${val.toFixed(2)}%`;
                                            const code = datasetsRaw[ctx.datasetIndex]?.code || '';
                                            return `${ctx.dataset.label} (${code}): ${formatted}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    stacked: true,
                                    title: { display: true, text: '贡献率 (%)' },
                                    ticks: { callback: (value) => `${value}%` }
                                },
                                y: { stacked: true }
                            }
                        }
                    });
                }
            }

            if (canvas3) {
                const labels = (data.unemployment_types_series || []).map(i => i.label);
                const prevValues = (data.unemployment_types_series || []).map(i => i.previous ?? null);
                const currValues = (data.unemployment_types_series || []).map(i => i.current ?? null);
                reportChart3 = new Chart(canvas3.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            { label: '上月', data: prevValues, backgroundColor: 'rgba(141, 169, 196, 0.7)' },
                            { label: '本月', data: currValues, backgroundColor: 'rgba(47, 120, 196, 0.8)' },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top', align: 'start' } },
                        scales: { y: { beginAtZero: true, title: { display: true, text: '失业率(%)' } } },
                    },
                });
            }

            if (canvas4) {
                const labels = (data.employment_participation_series || []).map(p => p.date);
                const employmentValues = (data.employment_participation_series || []).map(p => p.employment_rate != null ? Number(p.employment_rate) : null);
                const participationValues = (data.employment_participation_series || []).map(p => p.participation_rate != null ? Number(p.participation_rate) : null);
                const hasSeries = employmentValues.some(v => v !== null) || participationValues.some(v => v !== null);
                if (!hasSeries) {
                    const parent = canvas4.parentNode;
                    if (parent && !parent.querySelector('.figure-empty')) {
                        const holder = document.createElement('div');
                        holder.className = 'text-muted small figure-empty';
                        holder.textContent = '缺少就业率/劳动参与率数据';
                        parent.appendChild(holder);
                    }
                    return;
                } else {
                    const empty = canvas4.parentNode?.querySelector('.figure-empty');
                    if (empty) empty.remove();
                }
                reportChart4 = new Chart(canvas4.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            {
                                label: '就业率(%)',
                                data: employmentValues,
                                borderColor: '#2f78c4',
                                backgroundColor: 'rgba(47, 120, 196, 0.15)',
                                tension: 0.15,
                                pointRadius: 2,
                                yAxisID: 'y',
                            },
                            {
                                label: '劳动参与率(%)',
                                data: participationValues,
                                borderColor: '#ef6c00',
                                backgroundColor: 'rgba(239, 108, 0, 0.15)',
                                tension: 0.15,
                                pointRadius: 2,
                                yAxisID: 'y1',
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top', align: 'start' } },
                        scales: { 
                            y: { position: 'left', title: { display: true, text: '就业率(%)' } },
                            y1: { position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: '劳动参与率(%)' } }
                        },
                    },
                });
            }
        }

        function appendFigure(container, base64Image, caption) {
            if (!base64Image) return;
            const figure = document.createElement('figure');
            figure.className = 'report-figure';
            const img = document.createElement('img');
            img.src = `data:image/png;base64,${base64Image}`;
            img.alt = caption;
            const figcap = document.createElement('figcaption');
            figcap.textContent = caption;
            figure.appendChild(img);
            figure.appendChild(figcap);
            container.appendChild(figure);
        }

        function updateIndicatorSummary(indicators, unemploymentSeries) {
            const wrapper = document.getElementById('indicatorSummary');
            if (!wrapper) return;
            wrapper.innerHTML = '';

            const fredCodeMap = {
                '新增非农就业': 'PAYEMS',
                '失业率(U3)': 'UNRATE',
                '就业率': 'LNS12300060',
                '劳动参与率': 'CIVPART'
            };

            const metricItems = [];
            if (indicators && Array.isArray(indicators)) {
                indicators.forEach(item => {
                    const deltas = [];
                    if (item.mom_change) deltas.push(`环比 ${item.mom_change}`);
                    if (item.yoy_change) deltas.push(`同比 ${item.yoy_change}`);
                    const latestValue = item.latest_value !== null && item.latest_value !== undefined ? item.latest_value : '—';
                    const units = item.units || '';
                    metricItems.push({
                        title: item.name,
                        value: `${latestValue}${units}`,
                        detail: deltas.join(' · '),
                        context: item.context || '',
                        code: item.code || fredCodeMap[item.name]
                    });
                });
            }

            if (unemploymentSeries && Array.isArray(unemploymentSeries)) {
                unemploymentSeries.forEach(item => {
                    const delta = item.mom_delta !== null && item.mom_delta !== undefined ? `${item.mom_delta >= 0 ? '+' : ''}${item.mom_delta.toFixed(2)}` : null;
                    metricItems.push({
                        title: `${item.label} 失业率`,
                        value: item.current !== null && item.current !== undefined ? `${item.current.toFixed(2)}%` : '—',
                        detail: delta ? `环比 ${delta}` : '',
                        context: '',
                        code: item.code || fredCodeMap[item.label]
                    });
                });
            }

            if (metricItems.length === 0) {
                const placeholder = document.createElement('div');
                placeholder.className = 'text-muted small';
                placeholder.textContent = '暂无数据，请先生成一次研报。';
                wrapper.appendChild(placeholder);
                return;
            }

            metricItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'summary-item';
                const fredLink = item.code ? `<a class="summary-link text-primary" href="https://fred.stlouisfed.org/series/${item.code}" target="_blank" rel="noopener"><i class="bi bi-box-arrow-up-right"></i> FRED</a>` : '';
                card.innerHTML = `
                    <div class="summary-title">${item.title}</div>
                    <div class="summary-value">${item.value}</div>
                    ${item.detail ? `<div class="summary-meta">${item.detail}</div>` : ''}
                    ${fredLink ? `<div>${fredLink}</div>` : ''}
                `;
                wrapper.appendChild(card);
            });
        }

        function updateReportNav(headings) {
            const navList = document.getElementById('reportNavList');
            if (!navList) return;
            navList.innerHTML = '';
            if (!headings || headings.length === 0) {
                const placeholder = document.createElement('div');
                placeholder.className = 'list-group-item text-muted small';
                placeholder.textContent = '生成研报后显示章节';
                navList.appendChild(placeholder);
                return;
            }
            headings.forEach(h => {
                const item = document.createElement('a');
                item.className = 'list-group-item list-group-item-action';
                item.href = `#${h.id}`;
                item.innerHTML = `<span class="nav-label">${h.text}</span>`;
                navList.appendChild(item);
            });
        }

        function updateCpiNav(headings) {
            const navList = document.getElementById('cpiNavList');
            if (!navList) return;
            navList.innerHTML = '';
            if (!headings || headings.length === 0) {
                const placeholder = document.createElement('div');
                placeholder.className = 'list-group-item text-muted small';
                placeholder.textContent = '生成研报后显示章节';
                navList.appendChild(placeholder);
                return;
            }
            headings.forEach(h => {
                const item = document.createElement('a');
                item.className = 'list-group-item list-group-item-action';
                item.href = `#${h.id}`;
                item.innerHTML = `<span class="nav-label">${h.text}</span>`;
                navList.appendChild(item);
            });
        }

        function handleLLMError(llmError) {
            const errorEl = document.getElementById('llmError');
            if (!errorEl) return;
            if (llmError) {
                errorEl.textContent = llmError;
                errorEl.classList.remove('d-none');
            } else {
                errorEl.classList.add('d-none');
                errorEl.textContent = '';
            }
        }

        // -------------------------------
        // CPI 研报逻辑
        // -------------------------------
        function initializeCpiModule() {
            const monthInput = document.getElementById('cpiReportMonth');
            if (monthInput) {
                const now = new Date();
                const monthValue = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                monthInput.value = monthValue;
            }
            const btn = document.getElementById('generateCpiBtn');
            if (btn) {
                btn.addEventListener('click', handleCpiGeneration);
            }
            const pdfBtn = document.getElementById('exportCpiPdfBtn');
            if (pdfBtn) {
                pdfBtn.addEventListener('click', handleCpiPdfExport);
                pdfBtn.disabled = true;
            }
        }

        function setCpiLoading(isLoading, statusText) {
            const btn = document.getElementById('generateCpiBtn');
            const exportBtn = document.getElementById('exportCpiPdfBtn');
            const status = document.getElementById('cpiStatus');
            if (btn) {
                btn.disabled = isLoading;
                btn.innerHTML = isLoading
                    ? '<span class="loading"></span> 处理中...'
                    : '<i class="bi bi-play-circle"></i> 生成CPI图表与研判';
            }
            if (exportBtn && isLoading) exportBtn.disabled = true;
            if (status) {
                status.textContent = statusText || (isLoading ? '请稍候...' : '生成完成，可重新选择月份。');
            }
        }

        function setCpiExportEnabled(isEnabled) {
            const btn = document.getElementById('exportCpiPdfBtn');
            if (btn) btn.disabled = !isEnabled;
        }

        function handleCpiGeneration() {
            const reportMonth = document.getElementById('cpiReportMonth').value;
            if (!reportMonth) {
                showMessage('请先选择报告月份', 'warning');
                return;
            }
            lastCpiReportData = null;
            setCpiExportEnabled(false);
            setCpiLoading(true, '正在生成CPI图表...');
            fetch('/api/cpi/report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ report_month: reportMonth })
            })
            .then(response => response.json().then(data => {
                if (!response.ok) {
                    throw new Error(data.error || '生成失败');
                }
                return data;
            }))
            .then(data => {
                lastCpiReportData = data;
                updateCpiUI(data);
            })
            .catch(error => {
                console.error('生成CPI研报失败:', error);
                showMessage('生成CPI研报失败: ' + error.message, 'danger');
                setCpiLoading(false, '生成失败，请重试');
                setCpiExportEnabled(false);
            });
        }

        function handleCpiPdfExport() {
            if (!lastCpiReportData) {
                showMessage('请先生成CPI研报，再导出PDF', 'info');
                return;
            }
            const btn = document.getElementById('exportCpiPdfBtn');
            const original = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span> 生成PDF...';
            }
            fetch('/api/cpi/report.pdf', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ report_data: lastCpiReportData })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => { throw new Error(data.error || '导出失败'); });
                }
                return response.blob();
            })
            .then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const month = lastCpiReportData.report_month || 'report';
                a.href = url;
                a.download = `CPI研判_${month}.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                showMessage('PDF 导出完成', 'success');
            })
            .catch(error => {
                console.error('导出CPI PDF失败:', error);
                showMessage('导出CPI PDF失败: ' + error.message, 'danger');
            })
            .finally(() => {
                if (btn) {
                    btn.innerHTML = original || '<i class="bi bi-file-earmark-pdf"></i> 导出PDF';
                    setCpiExportEnabled(!!lastCpiReportData);
                }
            });
        }

        function updateCpiUI(data) {
            const windowInfo = data.chart_window;
            const weightText = data.weight_year ? ` · 权重年份：${data.weight_year}` : '';
            const windowText = windowInfo ? `图表区间：${windowInfo.start_date} - ${windowInfo.end_date}${weightText}` : `生成完成${weightText}`;
            setCpiLoading(false, windowText);
            setCpiExportEnabled(!!data);
            const headline = document.getElementById('cpiHeadlineBadge');
            if (headline) headline.textContent = data.headline_summary || '待生成';
            const windowChip = document.getElementById('cpiWindowChip');
            if (windowChip) windowChip.textContent = windowText;
            renderCpiCharts(data);
            renderContributionTable('cpiYoyTableBody', data.contributions_yoy, 'yoy');
            renderContributionTable('cpiMomTableBody', data.contributions_mom, 'mom');
            renderCpiIndicators(data.indicators);
            renderCpiText(data.report_text);
            handleCpiLLMError(data.llm_error);
        }

        function renderCpiCharts(data) {
            if (cpiChartYoy) { cpiChartYoy.destroy(); cpiChartYoy = null; }
            if (cpiChartMom) { cpiChartMom.destroy(); cpiChartMom = null; }

            const yoyCanvas = document.getElementById('cpiChartYoy');
            if (yoyCanvas) {
                const labels = (data.yoy_series || []).map(p => p.date);
                const cpiValues = (data.yoy_series || []).map(p => p.cpi_yoy ?? null);
                const coreValues = (data.yoy_series || []).map(p => p.core_yoy ?? null);
                cpiChartYoy = new Chart(yoyCanvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            { label: 'CPI同比', data: cpiValues, borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.15)', tension: 0.15, pointRadius: 2 },
                            { label: '核心CPI同比', data: coreValues, borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,0.12)', tension: 0.15, pointRadius: 2 },
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top', align: 'start' } },
                        scales: { y: { title: { display: true, text: '同比(%)' } } }
                    }
                });
            }

            const momCanvas = document.getElementById('cpiChartMom');
            if (momCanvas) {
                const labels = (data.mom_series || []).map(p => p.date);
                const cpiValues = (data.mom_series || []).map(p => p.cpi_mom ?? null);
                const coreValues = (data.mom_series || []).map(p => p.core_mom ?? null);
                cpiChartMom = new Chart(momCanvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            { label: 'CPI环比', data: cpiValues, borderColor: '#f97316', backgroundColor: 'rgba(249,115,22,0.12)', tension: 0.15, pointRadius: 2 },
                            { label: '核心CPI环比', data: coreValues, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.12)', tension: 0.15, pointRadius: 2 },
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top', align: 'start' } },
                        scales: { y: { title: { display: true, text: '环比(%)' } } }
                    }
                });
            }
        }

        function renderContributionTable(bodyId, rows, mode) {
            const tbody = document.getElementById(bodyId);
            if (!tbody) return;
            tbody.innerHTML = '';
            if (!rows || rows.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="7" class="text-center text-muted py-3">暂无数据</td>`;
                tbody.appendChild(tr);
                return;
            }
            const absMax = (arr, key) => {
                const vals = (arr || []).map(r => r[key]).filter(v => v !== null && v !== undefined).map(Number);
                if (!vals.length) return 0;
                return Math.max(...vals.map(v => Math.abs(v)));
            };
            const maxChange = absMax(rows, 'current');
            const maxContrib = absMax(rows, 'contribution');
            const maxDelta = absMax(rows, 'delta_contribution');

            const format = (val) => (val === null || val === undefined ? '—' : Number(val).toFixed(2));
            const bar = (val, max) => {
                if (val === null || val === undefined) {
                    return '<div class="text-muted">—</div>';
                }
                const safeMax = max || 1;
                const width = Math.min(100, Math.abs(val || 0) / safeMax * 100);
                const dirClass = val >= 0 ? 'pos' : 'neg';
                return `
                    <div class="bar-cell">
                        <div class="d-flex align-items-center" style="gap:6px;">
                            <span>${format(val)}</span>
                        </div>
                        <div class="bar-track">
                            <div class="bar-fill ${dirClass}" style="width:${width}%; left:${val >= 0 ? '0' : `${100 - width}%`};"></div>
                        </div>
                    </div>
                `;
            };
            const heat = (val, max) => {
                if (val === null || val === undefined) return '<span class="text-muted">—</span>';
                const safeMax = max || 1;
                const intensity = Math.min(1, Math.abs(val) / safeMax);
                const color = val >= 0
                    ? `rgba(249,115,22,${0.35 + 0.4 * intensity})`  /* 上升橙色 */
                    : `rgba(14,165,233,${0.35 + 0.4 * intensity})`; /* 下降青蓝 */
                return `
                    <span class="heat-chip">
                        <span class="heat-dot" style="background:${color};"></span>
                        <span>${format(val)}</span>
                    </span>
                `;
            };

            const nodes = (rows || []).map(r => ({ ...r, children: [] }));
            const byLabel = new Map();
            nodes.forEach(n => byLabel.set(n.label, n));
            const roots = [];
            nodes.forEach(n => {
                const parent = n.parent_label && byLabel.get(n.parent_label);
                if (parent) {
                    parent.children.push(n);
                } else {
                    roots.push(n);
                }
            });

            if (!contribCollapseState[mode]) {
                const initial = new Set();
                nodes.forEach(n => {
                    if (n.children && n.children.length) {
                        initial.add(n.label);
                    }
                });
                contribCollapseState[mode] = initial;
            }
            const collapsed = contribCollapseState[mode];

            const renderNode = (node, isAncestorCollapsed) => {
                if (isAncestorCollapsed) return;
                const hasChildren = node.children && node.children.length > 0;
                const isCollapsed = collapsed.has(node.label);
                const indentPx = (node.level || 0) * 14;
                const tr = document.createElement('tr');
                if (node.is_major && node.level === 0) tr.classList.add('major-row');
                tr.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center" style="gap:6px; padding-left:${indentPx}px;">
                            ${hasChildren ? `<button class="tree-toggle" data-label="${node.label}" data-mode="${mode}" aria-label="toggle">${isCollapsed ? '▸' : '▾'}</button>` : '<span class="tree-leaf-dot"></span>'}
                            <span class="${node.level === 0 ? 'fw-bold' : ''}">${node.label || '—'}</span>
                        </div>
                    </td>
                    <td>${format(node.weight)}</td>
                    <td>${bar(node.current, maxChange)}</td>
                    <td>${bar(node.contribution, maxContrib)}</td>
                    <td>${bar(node.previous, maxChange)}</td>
                    <td>${bar(node.previous_contribution, maxContrib)}</td>
                    <td>${heat(node.delta_contribution, maxDelta)}</td>
                `;
                tbody.appendChild(tr);
                if (!isCollapsed) {
                    (node.children || []).forEach(child => renderNode(child, false));
                }
            };

            roots.forEach(root => renderNode(root, false));

            tbody.querySelectorAll('.tree-toggle').forEach(btn => {
                btn.addEventListener('click', () => {
                    const label = btn.dataset.label;
                    const m = btn.dataset.mode;
                    const set = contribCollapseState[m] || new Set();
                    if (set.has(label)) set.delete(label);
                    else set.add(label);
                    contribCollapseState[m] = set;
                    renderContributionTable(bodyId, rows, mode);
                });
            });
        }

        function renderCpiIndicators(items) {
            const wrapper = document.getElementById('cpiIndicatorList');
            if (!wrapper) return;
            wrapper.innerHTML = '';
            if (!items || !items.length) {
                const placeholder = document.createElement('div');
                placeholder.className = 'text-muted small';
                placeholder.textContent = '暂无数据，请先生成一次研报。';
                wrapper.appendChild(placeholder);
                return;
            }
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'summary-item';
                const delta = item.delta ? `<div class="summary-meta">Δ ${item.delta}</div>` : '';
                card.innerHTML = `
                    <div class="summary-title">${item.name}</div>
                    <div class="summary-value">${item.value || '—'}</div>
                    ${delta}
                    ${item.context ? `<div class="summary-meta">${item.context}</div>` : ''}
                `;
                wrapper.appendChild(card);
            });
        }

        function renderCpiText(reportText) {
            const container = document.getElementById('cpiReportText');
            if (!container) return;
            container.innerHTML = '';
            const fig1 = document.getElementById('cpiFigure1');
            const fig2 = document.getElementById('cpiFigure2');
            const table1 = document.getElementById('cpiYoyWrapper');
            const table2 = document.getElementById('cpiMomWrapper');
            [fig1, fig2, table1, table2].forEach(node => {
                if (node && node.parentNode) node.parentNode.removeChild(node);
            });

            if (!reportText) {
                const p = document.createElement('p');
                p.className = 'text-muted';
                p.textContent = '未能生成研报内容，请检查DeepSeek配置。';
                container.appendChild(p);
                [fig1, fig2, table1, table2].forEach(node => node && container.appendChild(node));
                return;
            }
            const cleaned = stripMarkdownTables(stripCodeFence(reportText));
            container.innerHTML = renderMarkdown(cleaned);

            // 将图表/表格插入到对应的小标题之后，增强阅读顺序
            function placeAfterLabel(labelText, node) {
                if (!node) return;
                const headings = Array.from(container.querySelectorAll('h1,h2,h3'));
                for (const h of headings) {
                    if ((h.textContent || '').includes(labelText)) {
                        let insertAfter = h;
                        let sibling = h.nextSibling;
                        while (sibling) {
                            if (sibling.nodeType === 1 && ['P', 'UL', 'OL'].includes(sibling.tagName)) {
                                insertAfter = sibling;
                                break;
                            }
                            sibling = sibling.nextSibling;
                        }
                        insertAfter.parentNode.insertBefore(node, insertAfter.nextSibling);
                        return;
                    }
                }
                container.appendChild(node);
            }

            placeAfterLabel('图1', fig1);
            placeAfterLabel('图2', fig2);
            placeAfterLabel('表1', table1);
            placeAfterLabel('表2', table2);

            // 用LLM小标题更新图表标题
            const fixedFigureTitles = {
                '图1': '图1：美国CPI、核心CPI当月同比(%)',
                '图2': '图2：CPI、核心CPI季调环比(%)',
                '表1': '表1：当月CPI同比拉动拆分',
                '表2': '表2：当月季调CPI分项环比结构'
            };

            function syncFigureTitle(labelText, figureNode) {
                if (!figureNode) return;
                const titleEl = figureNode.querySelector('.figure-title');
                if (!titleEl) return;
                const fixed = fixedFigureTitles[labelText];
                if (fixed) {
                    titleEl.textContent = fixed;
                    return;
                }
                const headings = Array.from(container.querySelectorAll('h1,h2,h3'));
                const hit = headings.find(h => (h.textContent || '').includes(labelText));
                if (hit) titleEl.textContent = hit.textContent.trim();
            }
            syncFigureTitle('图1', fig1);
            syncFigureTitle('图2', fig2);
            syncFigureTitle('表1', table1);
            syncFigureTitle('表2', table2);

            const headings = Array.from(container.querySelectorAll('h1,h2,h3')).map((el, idx) => {
                if (!el.id) {
                    const slug = `cpi-section-${idx}-${el.textContent.trim().replace(/\s+/g, '-').toLowerCase()}`;
                    el.id = slug;
                }
                return { id: el.id, text: el.textContent.trim(), level: el.tagName.toLowerCase() };
            });
            updateCpiNav(headings);
        }

        function handleCpiLLMError(llmError) {
            const errorEl = document.getElementById('cpiLlmError');
            if (!errorEl) return;
            if (llmError) {
                errorEl.textContent = llmError;
                errorEl.classList.remove('d-none');
            } else {
                errorEl.classList.add('d-none');
                errorEl.textContent = '';
            }
        }
    </script>
</body>
</html>
